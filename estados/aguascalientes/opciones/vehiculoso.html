<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PADRÓN VEHICULAR - AGUASCALIENTES</title>
    <link rel="icon" type="image/png" href="../../../imagenes/camioneta.png">
    <link rel="stylesheet" href="../../diseños/diseñounafoto.css">
    
</head>
<body>
    <h1>VEHICULOS</h1>
        
    <div class="menu-overlay"></div>
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <header>
        <button class="menu-toggle" onclick="toggleMenu()">☰</button>
        <nav class="menu">
            <img src="../../../imagenes/gobernacion.jpg" class="logo-arriba-img" alt="Logo">
            <ul>
                <li><a href="../../../index.html">Inicio</a></li>
                <li class="submenu">
                    <a href="javascript:void(0);" onclick="toggleSubmenu(event)">Datos Nacionales</a>
                    <ul class="submenu-list">
                        <li><a href="../../../datos_nacionales/datosindex.html">Datos Nacionales</a></li>
                        <li><a href="../../../datos_nacionales/opcionesdatos/plantillad.html">Plantilla de Personal</a></li>
                        <li><a href="../../../datos_nacionales/opcionesdatos/tabulador.html">Tabulador</a></li>
                        <li><a href="../../../datos_nacionales/opcionesdatos/rubro.html">Gastos de Operación</a></li>
                        <li><a href="../../../datos_nacionales/opcionesdatos/estadofuerza.html">Analitico Estado Fuerza</a></li>
                        <li><a href="../../../datos_nacionales/opcionesdatos/unidadcd.html">Unidades Caninas</a></li>
                        <li><a href="../../../construccion.html">Inmuebles</a></li>
                        <li><a href="../../../construccion.html">Padron Vehicular</a></li>
                        <li><a href="../../../gestion/archivos.html">Gestion de Archvios</a></li>
                    </ul>
                </li>
                <li class="submenu">
                    <a href="javascript:void(0);" onclick="toggleSubmenu(event)">Información de ORs</a>
                    <ul class="submenu-list">
                        <li><a href="../aguascalientesindex.html">Aguascalientes</a></li>
                        <li><a href="../../baja_california/baja_californiaindex.html">Baja California</a></li>
                        <li><a href="../../baja_california_s/baja_california_surindex.html">Baja California Sur</a></li>
                        <li><a href="../../campeche/campecheindex.html">Campeche</a></li>
                        <li><a href="../../chiapas/chiapasindex.html">Chiapas</a></li>
                        <li><a href="../../chihuahua/chihuahuaindex.html">Chihuahua</a></li>
                        <li><a href="../../coahuila/coahuilaindex.html">Coahuila</a></li>
                        <li><a href="../../colima/colimaindex.html">Colima</a></li>
                        <li><a href="../../cdmx/cdmxindex.html">Ciudad de México</a></li>
                        <li><a href="../../durango/durangoindex.html">Durango</a></li>
                        <li><a href="../../guanajuato/guanajuatoindex.html">Guanajuato</a></li>
                        <li><a href="../../guerrero/guerreroindex.html">Guerrero</a></li>
                        <li><a href="../../hidalgo/hidalgoindex.html">Hidalgo</a></li>
                        <li><a href="../../jalisco/jaliscoindex.html">Jalisco</a></li>
                        <li><a href="../../edomex/edomexindex.html">Estado de México</a></li>
                        <li><a href="../../michoacan/michoacanindex.html">Michoacán</a></li>
                        <li><a href="../../morelos/morelosindex.html">Morelos</a></li>
                        <li><a href="../../nayarit/nayaritindex.html">Nayarit</a></li>
                        <li><a href="../../nuevo_leon/nuevo_leonindex.html">Nuevo León</a></li>
                        <li><a href="../../oaxaca/oaxacaindex.html">Oaxaca</a></li>
                        <li><a href="../../puebla/pueblaindex.html">Puebla</a></li>
                        <li><a href="../../quererato/queretaroindex.html">Querétaro</a></li>
                        <li><a href="../../quintanaroo/quintanarooindex.html">Quintana Roo</a></li>
                        <li><a href="../../san_luis/san_luisindex.html">San Luis Potosí</a></li>
                        <li><a href="../../sinaloa/sinaloaindex.html">Sinaloa</a></li>
                        <li><a href="../../sonora/sonoraindex.html">Sonora</a></li>
                        <li><a href="../../tabasco/tabascoindex.html">Tabasco</a></li>
                        <li><a href="../../tamaulipas/tamaulipasindex.html">Tamaulipas</a></li>
                        <li><a href="../../tlaxcala/tlaxcalaindex.html">Tlaxcala</a></li>
                        <li><a href="../../veracruz/veracruzindex.html">Veracruz</a></li>
                        <li><a href="../../yucatan/yucatanindex.html">Yucatán</a></li>
                        <li><a href="../../zacatecas/zacatecasindex.html">Zacatecas</a></li>
                    </ul>
                </li>
            </ul>
        </nav>
    </header>

    <div class="logo-container">
        <img src="../../../imagenes/inm logo.png" alt="Logo INM">
    </div>
    
    <!-- Contenedor principal del visor PDF -->
    <div class="pdf-container">
        <div id="pdf-viewer-container">
            <canvas id="pdf-canvas"></canvas>
        </div>
        <div class="pdf-controls">
            <button id="prev-page">Anterior</button>
            <span id="page-count">Página 1 de 1</span>
            <button id="next-page">Siguiente</button>
        </div>
        <div id="pdf-error" class="error-message" style="display: none;"></div>
    </div>

    <!-- Sección de información del archivo y descarga -->
    <div id="file-info-container" class="file-info" style="display: none;">
        <h3 id="file-name">Padrón Vehicular</h3>
        <p id="file-updated">Actualizado: --/--/----</p>
        <p id="file-size">Tamaño: -- MB</p>
        <a href="#" id="download-link" class="download-btn" download>Descargar Padrón</a>
    </div>

    <!-- Contenedor específico para iOS -->
    <div id="ios-container" class="ios-only">
        <p>Para una mejor experiencia en tu dispositivo iOS:</p>
        <a href="#" id="ios-pdf-link" class="ios-pdf-link" target="_blank">
            <img src="../../../imagenes/pdf-icon.png" alt="PDF">
            <span>Abrir Padrón Vehicular</span>
        </a>
        <p class="ios-instructions">Toca el botón arriba para abrir el PDF en una nueva ventana</p>
    </div>

    <button class="regresar-btn" onclick="window.history.back()">Regresar</button>

    <!-- Incluir PDF.js desde CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script>
        // Configuración
        const BACKEND_URL = 'https://control-operativo-1.onrender.com/api';
        const API_KEY = 'Xhy2md57';
        const ESTADO_FIJO = 'aguascalientes';
        const TIPO_DOCUMENTO = 'vehiculos';
        
        // Configura PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
        
        // Variables para el visor PDF
        let pdfDoc = null,
            pageNum = 1,
            pageRendering = false,
            pageNumPending = null,
            scale = 1.5,
            canvas = document.getElementById('pdf-canvas'),
            ctx = canvas.getContext('2d');

        // Detectar iOS
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                   (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        }

        // Mostrar/ocultar loading
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }

        // Mostrar mensaje de error
        function showError(message) {
            const pdfError = document.getElementById('pdf-error');
            pdfError.textContent = message;
            pdfError.style.display = 'block';
        }

        // Ocultar errores
        function hideErrors() {
            document.getElementById('pdf-error').style.display = 'none';
        }

        // Función para abrir/cerrar el menú
        function toggleMenu() {
            const menu = document.querySelector('.menu');
            const overlay = document.querySelector('.menu-overlay');
            menu.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        // Cerrar menú al hacer clic fuera
        document.querySelector('.menu-overlay').addEventListener('click', toggleMenu);

        // Función para submenús
        function toggleSubmenu(event) {
            event.preventDefault();
            document.querySelectorAll('.submenu.active').forEach(sub => {
                if (sub !== event.target.closest('.submenu')) {
                    sub.classList.remove('active');
                }
            });
            event.target.closest('.submenu').classList.toggle('active');
        }

        // Formatear fecha legible
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('es-MX', options);
        }

        // Renderizar página del PDF
        function renderPage(num) {
            pageRendering = true;
            showLoading(true);
            
            pdfDoc.getPage(num).then(function(page) {
                const viewport = page.getViewport({ scale: scale });
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                
                const renderTask = page.render(renderContext);
                
                renderTask.promise.then(function() {
                    pageRendering = false;
                    showLoading(false);
                    
                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                });
            });
            
            document.getElementById('page-count').textContent = 
                `Página ${num} de ${pdfDoc.numPages}`;
        }

        // Manejar cola de renderizado
        function queueRenderPage(num) {
            if (pageRendering) {
                pageNumPending = num;
            } else {
                renderPage(num);
            }
        }

        // Página anterior
        function onPrevPage() {
            if (pageNum <= 1) return;
            pageNum--;
            queueRenderPage(pageNum);
        }

        // Página siguiente
        function onNextPage() {
            if (pageNum >= pdfDoc.numPages) return;
            pageNum++;
            queueRenderPage(pageNum);
        }

        // Cargar PDF de Padrón Vehicular
        async function loadPadronVehicular() {
            showLoading(true);
            hideErrors();
            
            try {
                const response = await fetch(`${BACKEND_URL}/archivos/${ESTADO_FIJO}/${TIPO_DOCUMENTO}`, {
                    headers: { 'x-api-key': API_KEY }
                });
                
                if (!response.ok) throw new Error(`Error ${response.status}: ${response.statusText}`);
                
                const result = await response.json();
                
                if (!result?.data || result.data.length === 0) {
                    throw new Error('No se encontraron documentos de padrón vehicular para Aguascalientes');
                }
                
                const latestPDF = result.data.sort((a, b) => 
                    new Date(b.uploaded_at) - new Date(a.uploaded_at)
                )[0];
                
                // Actualizar información del archivo
                const fileInfoContainer = document.getElementById('file-info-container');
                document.getElementById('file-name').textContent = latestPDF.filename || 'Padrón Vehicular';
                document.getElementById('file-updated').textContent = `Actualizado: ${formatDate(latestPDF.uploaded_at)}`;
                document.getElementById('file-size').textContent = `Tamaño: ${(latestPDF.size / (1024*1024)).toFixed(2)} MB`;
                document.getElementById('download-link').href = latestPDF.url;
                fileInfoContainer.style.display = 'block';
                
                // Configuración específica para iOS
                if (isIOS()) {
                    const iosLink = document.getElementById('ios-pdf-link');
                    iosLink.href = latestPDF.url;
                }
                
                // Cargar PDF con PDF.js
                const loadingTask = pdfjsLib.getDocument(latestPDF.url);
                loadingTask.promise.then(function(pdf) {
                    pdfDoc = pdf;
                    document.getElementById('page-count').textContent = 
                        `Página 1 de ${pdf.numPages}`;
                    
                    // Ajustar escala inicial según el ancho del dispositivo
                    scale = window.innerWidth < 768 ? 1.0 : 1.5;
                    
                    renderPage(1);
                }).catch(function(error) {
                    console.error('PDF.js error:', error);
                    showError('Error al cargar el PDF. Por favor intenta descargarlo.');
                    
                    // Mostrar opción de descarga como fallback
                    fileInfoContainer.innerHTML += `
                        <p class="error-message">No se pudo cargar la vista previa</p>
                    `;
                });
                
            } catch (error) {
                console.error('Error:', error);
                showError(`Error al cargar el padrón vehicular: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            // Asignar eventos a los controles del PDF
            document.getElementById('prev-page').addEventListener('click', onPrevPage);
            document.getElementById('next-page').addEventListener('click', onNextPage);
            
            // Cargar el padrón vehicular
            loadPadronVehicular();
            
            // Cerrar submenús al hacer clic en opción
            document.querySelectorAll('.submenu-list a').forEach(link => {
                link.addEventListener('click', () => {
                    document.querySelectorAll('.submenu').forEach(sub => {
                        sub.classList.remove('active');
                    });
                });
            });
            
            // Manejar clic en el enlace de iOS
            document.getElementById('ios-pdf-link')?.addEventListener('click', function(e) {
                if (isIOS()) {
                    window.open(this.href, '_blank');
                    e.preventDefault();
                }
            });
            
            // Ajustar el tamaño del canvas cuando cambia el tamaño de la ventana
            window.addEventListener('resize', function() {
                if (pdfDoc) {
                    scale = window.innerWidth < 768 ? 1.0 : 1.5;
                    queueRenderPage(pageNum);
                }
            });
        });
    </script>
</body>
</html>