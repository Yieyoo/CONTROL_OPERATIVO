<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PLANTILLA DE PERSONAL - BAJA CALIFORNIA</title>
    <link rel="icon" type="image/png" href="../../../imagenes/pasaporte.png">
    <link rel="stylesheet" href="../../diseños/diseñounafoto.css">
</head>
<body>
    
    <!-- Contenedor para el título personalizado -->
    <div id="tituloContainer" class="titulo-personalizado">
        Cargando título...
    </div>
    
    <!-- Resto de tu HTML permanece igual -->
    <div class="menu-overlay"></div>
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <header>
        <button class="menu-toggle" onclick="toggleMenu()">☰</button>
        <nav class="menu">
            <img src="../../../imagenes/gobernacion.jpg" class="logo-arriba-img" alt="Logo">
            <ul>
                <li><a href="../../../index.html">Inicio</a></li>
                <li class="submenu">
                    <a href="javascript:void(0);" onclick="toggleSubmenu(event)">Datos Nacionales</a>
                    <ul class="submenu-list">
                        <li><a href="../../../datos_nacionales/datosindex.html">Datos Nacionales</a></li>
                        <li><a href="../../../datos_nacionales/opcionesdatos/plantillad.html">Plantilla de Personal</a></li>
                        <li><a href="../../../datos_nacionales/opcionesdatos/tabulador.html">Tabulador</a></li>
                        <li><a href="../../../datos_nacionales/opcionesdatos/rubro.html">Gastos de Operación</a></li>
                        <li><a href="../../../datos_nacionales/opcionesdatos/estadofuerza.html">Analitico Estado Fuerza</a></li>
                        <li><a href="../../../datos_nacionales/opcionesdatos/unidadcd.html">Unidades Caninas</a></li>
                        <li><a href="../../../construccion.html">Inmuebles</a></li>
                        <li><a href="../../../construccion.html">Padron Vehicular</a></li>
                        <li><a href="../../../gestion/archivos.html">Gestion de Archvios</a></li>
                    </ul>
                </li>
                <li class="submenu">
                    <a href="javascript:void(0);" onclick="toggleSubmenu(event)">Información de ORs</a>
                    <ul class="submenu-list">
                        <li><a href="../../baja_california/baja_californiaindex.html">Baja California</a></li>
                    </ul>
                </li>
            </ul>
        </nav>
    </header>

    <div class="logo-container">
        <img src="../../../imagenes/inm logo.png" alt="Logo INM">
    </div>
    
    <div class="pdf-container">
        <iframe 
            id="pdf-viewer" 
            class="pdf-embed"
            frameborder="0"
            title="Visualizador de PDF"
        ></iframe>
        <div id="pdf-error" class="error-message" style="display: none;"></div>
    </div>

    <div class="mobile-images">
        <div id="mobile-error" class="error-message" style="display: none;"></div>
    </div>

    <button class="regresar-btn" onclick="window.history.back()">Regresar</button>

    <script>
    // Configuración
    const BACKEND_URL = 'https://control-operativo-1.onrender.com/api';
    const API_KEY = 'Xhy2md57';
    const ESTADO_FIJO = 'aguascalientes';
    const TIPO_DOCUMENTO = 'plantilla_personal';

    // Función para obtener y cargar el título personalizado
    async function cargarTituloPersonalizado() {
        const tituloContainer = document.getElementById('tituloContainer');

        try {
            // 1. Obtener el archivo más reciente con título
            const archivosResponse = await fetch(`${BACKEND_URL}/archivos/${ESTADO_FIJO}/${TIPO_DOCUMENTO}`, {
                headers: { 'x-api-key': API_KEY }
            });

            if (archivosResponse.ok) {
                const { data: archivos } = await archivosResponse.json();
                if (archivos.length > 0) {
                    const ultimoArchivo = archivos.sort((a, b) => 
                        new Date(b.uploaded_at) - new Date(a.uploaded_at)
                    )[0];

                    if (ultimoArchivo.titulo_documento) {
                        tituloContainer.textContent = ultimoArchivo.titulo_documento;
                        return;
                    }
                }
            }

            // 2. Obtener desde endpoint de títulos
            const tituloResponse = await fetch(`${BACKEND_URL}/obtener-titulo/${ESTADO_FIJO}`, {
                headers: { 'x-api-key': API_KEY }
            });

            if (tituloResponse.ok) {
                const data = await tituloResponse.json();
                if (data.titulo) {
                    tituloContainer.textContent = data.titulo;
                    return;
                }
            }

            // 3. Título por defecto
            tituloContainer.textContent = 'Plantilla de Personal - Aguascalientes';

        } catch (error) {
            console.error('Error:', error);
            tituloContainer.textContent = 'Plantilla de Personal - Aguascalientes';
            tituloContainer.style.color = 'red';
        }
    }

    // Mostrar/ocultar loading
    function showLoading(show) {
        document.getElementById('loading').style.display = show ? 'flex' : 'none';
    }

    // Mostrar mensaje de error
    function showError(message, target = 'both') {
        if (target === 'both' || target === 'pdf') {
            const pdfError = document.getElementById('pdf-error');
            pdfError.textContent = message;
            pdfError.style.display = 'block';
        }
        if (target === 'both' || target === 'mobile') {
            const mobileError = document.getElementById('mobile-error');
            mobileError.textContent = message;
            mobileError.style.display = 'block';
        }
    }

    // Ocultar errores
    function hideErrors() {
        document.getElementById('pdf-error').style.display = 'none';
        document.getElementById('mobile-error').style.display = 'none';
    }

    // Función para abrir/cerrar el menú
    function toggleMenu() {
        const menu = document.querySelector('.menu');
        const overlay = document.querySelector('.menu-overlay');
        menu.classList.toggle('active');
        overlay.classList.toggle('active');
    }

    // Cerrar menú al hacer clic fuera
    document.querySelector('.menu-overlay').addEventListener('click', toggleMenu);

    // Función para submenús
    function toggleSubmenu(event) {
        event.preventDefault();
        document.querySelectorAll('.submenu.active').forEach(sub => {
            if (sub !== event.target.closest('.submenu')) {
                sub.classList.remove('active');
            }
        });
        event.target.closest('.submenu').classList.toggle('active');
    }

    // Formatear fecha legible
    function formatDate(dateString) {
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        return new Date(dateString).toLocaleDateString('es-MX', options);
    }

    // Cargar PDF de Plantilla de Personal de Aguascalientes
    async function loadPlantillaPersonal() {
        showLoading(true);
        hideErrors();

        try {
            console.log(`Consultando API para: ${ESTADO_FIJO}/${TIPO_DOCUMENTO}`);
            const response = await fetch(`${BACKEND_URL}/archivos/${ESTADO_FIJO}/${TIPO_DOCUMENTO}`, {
                headers: { 'x-api-key': API_KEY }
            });

            if (!response.ok) throw new Error(`Error ${response.status}: ${response.statusText}`);

            const result = await response.json();
            console.log('Respuesta API:', result);

            if (!result?.data) throw new Error('Formato de respuesta inválido');

            const pdfViewer = document.getElementById('pdf-viewer');
            const mobileContainer = document.querySelector('.mobile-images');

            if (result.data.length > 0) {
                const latestPDF = result.data.sort((a, b) => 
                    new Date(b.uploaded_at) - new Date(a.uploaded_at)
                )[0];

                pdfViewer.src = latestPDF.url;

                mobileContainer.innerHTML = `
                    <div class="file-info">
                        <h3>${latestPDF.filename || 'Plantilla de Personal'}</h3>
                        <p>Actualizado: ${formatDate(latestPDF.uploaded_at)}</p>
                        <p>Tamaño: ${(latestPDF.size / (1024*1024)).toFixed(2)} MB</p>
                        <a href="${latestPDF.url}" class="download-btn" download>
                            Descargar Plantilla
                        </a>
                    </div>
                `;
            } else {
                showError('No se encontraron documentos de plantilla de personal para Aguascalientes', 'both');
            }
        } catch (error) {
            console.error('Error:', error);
            showError(`Error al cargar la plantilla: ${error.message}`, 'both');
        } finally {
            showLoading(false);
        }
    }

    // Inicialización
    document.addEventListener('DOMContentLoaded', () => {
        cargarTituloPersonalizado();
        if (document.getElementById('pdf-viewer')) {
            loadPlantillaPersonal();
        }

        // Cerrar submenús al hacer clic en opción
        document.querySelectorAll('.submenu-list a').forEach(link => {
            link.addEventListener('click', () => {
                document.querySelectorAll('.submenu').forEach(sub => {
                    sub.classList.remove('active');
                });
            });
        });
    });
</script>

</body>
</html>